name: CI – Test, Lint, Build & Package

on:
push:
branches: [main, develop]
pull_request:
branches: [main]

env:
PYTHON_VERSION: "3.12"

jobs:

# ─────────────────────────────

# LINT JOB

# ─────────────────────────────

lint:
name: Lint
runs-on: ubuntu-latest

```
steps:
  - name: Checkout repository
    uses: actions/checkout@v4

  - name: Setup Python
    uses: actions/setup-python@v5
    with:
      python-version: ${{ env.PYTHON_VERSION }}

  - name: Install dependencies
    run: |
      python -m pip install --upgrade pip
      pip install -r requirements.txt
```

# ─────────────────────────────

# TEST JOB

# ─────────────────────────────

test:
name: Test
runs-on: ubuntu-latest
needs: lint

```
steps:
  - name: Checkout repository
    uses: actions/checkout@v4

  - name: Setup Python
    uses: actions/setup-python@v5
    with:
      python-version: ${{ env.PYTHON_VERSION }}

  - name: Install dependencies
    run: |
      python -m pip install --upgrade pip
      pip install -r requirements.txt

  - name: Run pytest with coverage
    run: |
      pytest --cov=app --cov-report=xml --cov-report=term-missing

  - name: Upload coverage report
    uses: actions/upload-artifact@v4
    if: always()
    with:
      name: coverage-report
      path: coverage.xml
```

# ─────────────────────────────

# BUILD ZIP JOB

# ─────────────────────────────

build:
name: Build & Package Zip
runs-on: ubuntu-latest
needs: test

```
steps:
  - name: Checkout repository
    uses: actions/checkout@v4

  - name: Setup Python
    uses: actions/setup-python@v5
    with:
      python-version: ${{ env.PYTHON_VERSION }}

  - name: Install dependencies into dist folder
    run: |
      mkdir -p dist/app_package
      pip install --no-cache-dir -r requirements.txt --target dist/app_package/vendor
      cp -r app dist/app_package/
      cp run.py wsgi.py requirements.txt dist/app_package/

  - name: Create ZIP package
    run: |
      cd dist
      zip -r ../employee-api-${{ github.sha }}.zip app_package/

  - name: Upload ZIP artifact
    uses: actions/upload-artifact@v4
    with:
      name: employee-api-package
      path: employee-api-*.zip
      retention-days: 30
```

# ─────────────────────────────

# DOCKER JOB

# ─────────────────────────────

docker:
name: Docker Build & Test
runs-on: ubuntu-latest
needs: test

```
steps:
  - name: Checkout repository
    uses: actions/checkout@v4

  - name: Setup Docker Buildx
    uses: docker/setup-buildx-action@v3

  - name: Build Docker image
    run: |
      docker build -t employee-api:${{ github.sha }} .
      docker build -t employee-api:latest .

  - name: Run Docker container
    run: |
      docker run -d --name test-api -p 5000:5000 \
      -e SECRET_KEY=ci-secret \
      -e JWT_SECRET_KEY=ci-jwt-secret \
      employee-api:latest

  - name: Wait for container startup
    run: sleep 8

  - name: Test health endpoint (FIXED)
    run: |
      curl -f http://localhost:5000/health

  - name: Stop container
    run: |
      docker stop test-api
      docker rm test-api
```
